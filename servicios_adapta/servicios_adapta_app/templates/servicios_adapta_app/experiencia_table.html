{% extends './base.html' %}
{% block title %}Experiencia-Tabla{% endblock %}
{% block content %}
<div class="tableForm">
    <div class="top-section">
        <h1>Experiencias</h1>
        <div class="filters">
            <label for="codigo-filter" class="title">Filtrar por Código:</label>
            <input type="text" id="codigo-filter">
            <br>
            <label for="cat-servicios-filter" class="title">Filtrar por Categoría de Servicios:</label>
            <select id="cat-servicios-filter">
                <option value="">Todos</option>
                {% for choice in CAT_CHOICES %}
                    <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                {% endfor %}
            </select>
            <br>
            <label for="proyecto-filter" class="title">Filtrar por Proyecto:</label>
            <select id="proyecto-filter">
                <option value="">Todos</option>
                {% for proyecto in proyectos %}
                    <option value="{{ proyecto.id }}">{{ proyecto.nombre }}</option>
                {% endfor %}
            </select>
            <br>
        </div>
        <div class="sub-section">
            <a href="{% url 'experiencia-agregar' %}">Agregar Experiencia</a>
        </div>
    </div>
    <div class="table-section">
        <table id="contratos-table">
            <thead>
                <tr>
                    <th></th>
                    <th>Código</th>
                    <th>Fecha Inicio</th>
                    <th>Fecha Fin</th>
                    <th>Nombre</th>
                    <th>Razón Social</th>
                    <th>Categoría Servicios</th>
                    <th>Sector</th>
                    <th>Localización</th>
                    <th>Nombre Contacto</th>
                    <th>Telefono Contacto</th>
                    <th>eMail Contacto</th>
                    <th>Ficha</th>
                    <th>Atestado</th>
                    <th>Roles</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for contrato in contratos %}
                <tr data-codigo="{{ contrato.codigo }}" data-cat-servicios="{{ contrato.catServicios }}" data-proyecto="{{ contrato.proyecto.id }}">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ contrato.codigo }}</td>
                    <td>{{ contrato.fechaInicio }}</td>
                    <td>{% if contrato.fechaFin %}
                            {{ contrato.fechaFin|date:"M. d, Y" }}
                        {% else %}
                            En curso
                        {% endif %}
                    </td>
                    <td>{{ contrato.proyecto.nombre }}</td>
                    <td>{{ contrato.proyecto.razon.nombre }}</td>
                    <td>{{ contrato.get_catServicios_display }}</td>
                    <td>{{ contrato.proyecto.get_sector_display }}</td>
                    <td>{{ contrato.proyecto.localizacion.all|join:', ' }}</td>
                    <td>{{ contrato.proyecto.contacto_nombre }}</td>
                    <td>{{ contrato.proyecto.contacto_telefono }}</td>
                    <td>{{ contrato.proyecto.contacto_mail }}</td>
                    <td><a href="{{ contrato.ficha }}" target="_blank">Ver Ficha</a></td>
                    <td><a href="{{ contrato.atestado }}" target="_blank">Ver Atestado</a></td>
                    <td>
                        {% for contrato_empleado in contrato.contratoempleado_set.all %}
                            {{ contrato_empleado.empleado.nombre }} - {{ contrato_empleado.rol.nombre }}<br>
                        {% endfor %}
                    </td>
                    <td>
                        <a href="{% url 'experiencia-editar' contrato.id %}">Editar</a>
                        <a href="{% url 'borrar_contrato' contrato.id %}">Borrar</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Función para filtrar la tabla de contratos
        function filtrarContratos() {
            const codigoFilter = $("#codigo-filter").val().toUpperCase();
            const catServiciosFilter = $("#cat-servicios-filter").val();
            const proyectoFilter = $("#proyecto-filter").val();

            $("#contratos-table tbody tr").each(function () {
                const $row = $(this);
                const codigo = $row.data("codigo").toUpperCase();
                const catServicios = $row.data("cat-servicios");
                const proyecto = $row.data("proyecto");

                // Verificar si el contrato coincide con los filtros seleccionados
                const codigoMatch = codigo.includes(codigoFilter);
                const catServiciosMatch = catServiciosFilter === "" || catServicios === catServiciosFilter;
                const proyectoMatch = proyectoFilter === "" || proyecto === parseInt(proyectoFilter);

                // Ocultar o mostrar la fila según los filtros
                if (codigoMatch && catServiciosMatch && proyectoMatch) {
                    $row.show();
                } else {
                    $row.hide();
                }
            });
        }

        // Llamar a la función de filtrado al cargar la página y cuando cambien los filtros
        filtrarContratos();
        $("#codigo-filter, #cat-servicios-filter, #proyecto-filter").change(filtrarContratos);
        });
</script>

{% endblock %}
