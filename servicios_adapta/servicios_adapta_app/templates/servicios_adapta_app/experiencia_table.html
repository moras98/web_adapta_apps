{% extends './base.html' %}
{% block title %}Experiencia-Tabla{% endblock %}
{% block content %}
<div class="tableForm">
    <div class="top-section">
        <h1>Experiencias</h1>
        <div class="filters">
            <!-- Filtrado por codigo -->
            <label for="codigo-filter" class="title">Filtrar por Código:</label>
            <input type="text" id="codigo-filter">
            <!-- Filtrado por categoria -->
            <label for="cat-servicios-filter" class="title">Filtrar por Categoría de Servicios:</label>
            <select id="cat-servicios-filter">
                <option value="">Todos</option>
                {% for choice in CAT_CHOICES %}
                    <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                {% endfor %}
            </select>
            <!-- Filtrado por sector -->
            <label for="sector-filter" class="title">Filtrar por Sector:</label>
            <select id="sector-filter">
                <option value="">Todos</option>
                {% for choice in SECTOR_CHOICES %}
                    <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                {% endfor %}
            </select>
            <!-- Filtrado razon social -->
            <label for="razon-filter" class="title">Filtrar por Razon Social:</label>
            <select id="razon-filter">
                <option value="">Todos</option>
                {% for razon in razones %}
                    <option value="{{ razon.id }}">{{ razon.nombre }}</option>
                {% endfor %}
            </select>
            <!-- Filtrado proyecto -->
            <label for="proyecto-filter" class="title">Filtrar por Proyecto:</label>
            <select id="proyecto-filter">
                <option value="">Todos</option>
                {% for proyecto in proyectos %}
                    <option value="{{ proyecto.id }}">{{ proyecto.nombre }}</option>
                {% endfor %}
            </select>
            <!-- Filtrado por fehca inicio -->
            <label for="dia-inicio-filter" class="title">Filtrar por fecha de inicio:</label>
            <input type="text" id="dia-inicio-filter" placeholder="Día" maxlength="2">
            <input type="text" id="mes-inicio-filter" placeholder="Mes" maxlength="2">
            <input type="text" id="ano-inicio-filter" placeholder="Año" maxlength="4">
            <!-- Filtrado por fecha fin -->
            <label for="dia-fin-filter" class="title">Filtrar por Fecha Fin:</label>
            <input type="text" id="dia-fin-filter" placeholder="Dia">
            <input type="text" id="mes-fin-filter" placeholder="Mes">
            <input type="text" id="ano-fin-filter" placeholder="Año">
            <select id="en-curso-filter">
                <option value="">Todo</option>
                <option value="en_curso">En curso</option>
            </select>
            <!-- Exportar a excel -->
            <button id="exportar-excel">Exportar a Excel</button>
        </div>
        <div class="sub-section">
            <a href="{% url 'experiencia-agregar' %}">Agregar Experiencia</a>
        </div>
    </div>
    <div class="table-section">
        <table id="contratos-table">
            <thead>
                <tr>
                    <th></th>
                    <th>Código</th>
                    <th>Fecha Inicio</th>
                    <th>Fecha Fin</th>
                    <th>Nombre</th>
                    <th>Razón Social</th>
                    <th>Categoría Servicios</th>
                    <th>Sector</th>
                    <th>Localización</th>
                    <th>Nombre Contacto</th>
                    <th>Telefono Contacto</th>
                    <th>eMail Contacto</th>
                    <th>Ficha</th>
                    <th>Atestado</th>
                    <th>Roles</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for contrato in contratos %}
                <tr data-codigo="{{ contrato.codigo }}"
                    data-cat-servicios="{{ contrato.catServicios }}"  
                    data-cat-servicios-display="{{ contrato.get_catServicios_display }}" 
                    data-proyecto="{{ contrato.proyecto.id }}" 
                    data-razon="{{ contrato.proyecto.razon.id }}"
                    data-sector="{{ contrato.proyecto.sector }}"
                    data-sector-display="{{ contrato.proyecto.get_sector_display }}" 
                    data-fecha-inicio="{{ contrato.fechaInicio.day }}-{{ contrato.fechaInicio.month }}-{{ contrato.fechaInicio.year }}"
                    {% if contrato.fechaFin %}
                        data-fecha-fin="{{ contrato.fechaFin.day }}-{{ contrato.fechaFin.month }}-{{ contrato.fechaFin.year }}"
                    {% else %}
                        data-fecha-fin="En curso"
                    {% endif %}
                    data-localizacion="{{ contrato.proyecto.localizacion.all|join:', ' }}"
                    data-contacto-nombre="{{ contrato.proyecto.contacto_nombre }}"
                    data-contacto-telefono="{{ contrato.proyecto.contacto_telefono }}"
                    data-contacto-mail="{{ contrato.proyecto.contacto_mail }}"
                    data-ficha="{{ contrato.ficha }}"
                    data-atestado="{{ contrato.atestado }}"
                    data-empleados="{% for contrato_empleado in contrato.contratoempleado_set.all %}{{ contrato_empleado.empleado.nombre }} - {{ contrato_empleado.rol.nombre }}; {% endfor %}"
                >
                    <td>{{ forloop.counter }}</td>
                    <td>{{ contrato.codigo }}</td>
                    <td>{{ contrato.fechaInicio }}</td>
                    <td>{% if contrato.fechaFin %}
                            {{ contrato.fechaFin|date:"M. d, Y" }}
                        {% else %}
                            En curso
                        {% endif %}
                    </td>
                    <td>{{ contrato.proyecto.nombre }}</td>
                    <td>{{ contrato.proyecto.razon.nombre }}</td>
                    <td>{{ contrato.get_catServicios_display }}</td>
                    <td>{{ contrato.proyecto.get_sector_display }}</td>
                    <td>{{ contrato.proyecto.localizacion.all|join:', ' }}</td>
                    <td>{{ contrato.proyecto.contacto_nombre }}</td>
                    <td>{{ contrato.proyecto.contacto_telefono }}</td>
                    <td>{{ contrato.proyecto.contacto_mail }}</td>
                    <td><a href="{{ contrato.ficha }}" target="_blank">Ver Ficha</a></td>
                    <td><a href="{{ contrato.atestado }}" target="_blank">Ver Atestado</a></td>
                    <td>
                        {% for contrato_empleado in contrato.contratoempleado_set.all %}
                            {{ contrato_empleado.empleado.nombre }} - {{ contrato_empleado.rol.nombre }}<br>
                        {% endfor %}
                    </td>
                    <td>
                        <a href="{% url 'experiencia-editar' contrato.id %}">Editar</a>
                        <a href="{% url 'borrar_contrato' contrato.id %}">Borrar</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Función para filtrar la tabla de contratos
    function filtrarContratos() {
        const codigoFilter = $("#codigo-filter").val().toUpperCase();
        const catServiciosFilter = $("#cat-servicios-filter").val();
        const proyectoFilter = $("#proyecto-filter").val();
        const sectorFilter = $("#sector-filter").val();
        
        const diaInicioFilter = $("#dia-inicio-filter").val();
        const mesInicioFilter = $("#mes-inicio-filter").val();
        const anoInicioFilter = $("#ano-inicio-filter").val();

        const diaFinFilter = $("#dia-fin-filter").val();
        const mesFinFilter = $("#mes-fin-filter").val();
        const anoFinFilter = $("#ano-fin-filter").val();
        const enCursoFilter = $("#en-curso-filter").val();

        $("#contratos-table tbody tr").each(function () {
            const $row = $(this);
            const codigo = $row.data("codigo").toUpperCase();
            const catServicios = $row.data("cat-servicios");
            const proyecto = $row.data("proyecto");
            const fechaInicio = $row.data("fecha-inicio");
            const fechaFin = $row.data("fecha-fin");
            const sector = $row.data("sector");

            // Verificar si el contrato coincide con los filtros seleccionados
            const codigoMatch = codigo.includes(codigoFilter);
            const catServiciosMatch = catServiciosFilter === "" || catServicios === catServiciosFilter;
            const sectorMatch = sectorFilter === "" || sector === sectorFilter;
            const proyectoMatch = proyectoFilter === "" || proyecto === parseInt(proyectoFilter);
            const fechaInicioMatch = verificarFechaInicio(fechaInicio, diaInicioFilter, mesInicioFilter, anoInicioFilter);
            const fechaFinMatch = verificarFechaFin(fechaFin, diaFinFilter, mesFinFilter, anoFinFilter, enCursoFilter);

            // Ocultar o mostrar la fila según los filtros
            if (codigoMatch && catServiciosMatch && sectorMatch && proyectoMatch && fechaInicioMatch && fechaFinMatch) {
                $row.show();
            } else {
                $row.hide();
            }
        });
    }

    // Función para verificar si una fecha de inicio coincide con los filtros de fecha de inicio
    function verificarFechaInicio(fechaInicio, diaInicioFilter, mesInicioFilter, anoInicioFilter) {
        if (!diaInicioFilter && !mesInicioFilter && !anoInicioFilter) {
            return true;
        }

        const fechaInicioParts = fechaInicio.split("-");
        const diaInicio = fechaInicioParts[0];
        const mesInicio = fechaInicioParts[1];
        const anoInicio = fechaInicioParts[2];
        

        if (diaInicioFilter && diaInicioFilter !== diaInicio) {
            return false;
        }

        if (mesInicioFilter && mesInicioFilter !== mesInicio) {
            return false;
        }

        if (anoInicioFilter && anoInicioFilter !== anoInicio) {
            return false;
        }

        return true;
    }

    // Función para verificar si una fecha de fin coincide con los filtros de fecha de fin
    function verificarFechaFin(fechaFin, diaFinFilter, mesFinFilter, anoFinFilter, enCursoFilter) {
        if (enCursoFilter === "en_curso") {
            return fechaFin === "En curso";
        }

        if (!diaFinFilter && !mesFinFilter && !anoFinFilter) {
            return true;
        }

        if (fechaFin === "En curso") {
            return false;
        }

        const fechaFinParts = fechaFin.split("-");
        const diaFin = fechaFinParts[0];
        const mesFin = fechaFinParts[1];
        const anoFin = fechaFinParts[2];

        console.log(diaFin);
        console.log(fechaFin);

        if (diaFinFilter && diaFinFilter !== diaFin) {
            return false;
        }

        if (mesFinFilter && mesFinFilter !== mesFin) {
            return false;
        }

        if (anoFinFilter && anoFinFilter !== anoFin) {
            return false;
        }

        return true;
    }

    // Llamar a la función de filtrado al cargar la página y cuando cambien los filtros
    filtrarContratos();
    $("#codigo-filter, #cat-servicios-filter, #proyecto-filter, #sector-filter, #dia-inicio-filter, #mes-inicio-filter, #ano-inicio-filter, #dia-fin-filter, #mes-fin-filter, #ano-fin-filter, #en-curso-filter").on("keyup change", filtrarContratos);

    function exportarExcel() {
        const contratosFiltrados = [];
        $("#contratos-table tbody tr:visible").each(function () {
            const codigo = $(this).data("codigo");
            const catServicios = $(this).data("cat-servicios-display");
            const proyecto = $(this).data("proyecto");
            const fechaInicio = $(this).data("fecha-inicio");
            const fechaFin = $(this).data("fecha-fin");
            const razon = $(this).data("razon");
            const sector = $(this).data("sector-display");
            const localizacion = $(this).data("localizacion");
            const contactoNombre = $(this).data("contacto-nombre");
            const contactoTelefono = $(this).data("contacto-telefono");
            const contactoMail = $(this).data("contacto-mail");
            const ficha = $(this).data("ficha");
            const atestado = $(this).data("atestado");
            const empleados = $(this).data("empleados");

            contratosFiltrados.push({
                Código: codigo,
                "Fecha Inicio": fechaInicio,
                "Fecha Fin": fechaFin,
                Nombre: proyecto,
                "Razón Social": razon,
                "Categoría de Servicios": catServicios,
                Sector: sector,
                "Localización": localizacion,
                "Nombre contacto": contactoNombre,
                "Telefono contacto": contactoTelefono,
                "eMail contacto": contactoMail,
                Ficha: ficha,
                Atestado: atestado,
                Roles: empleados
            });
        });

        // Crear un libro de trabajo de Excel
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet(contratosFiltrados);

        // Agregar la hoja de trabajo al libro
        XLSX.utils.book_append_sheet(workbook, worksheet, "Contratos Filtrados");

        // Guardar el libro en un archivo Excel
        XLSX.writeFile(workbook, "contratos_filtrados.xlsx");
    }

    // Agregar el evento click al botón de exportación
    $("#exportar-excel").on("click", function () {
        exportarExcel();
    });

</script>

{% endblock %}
